# Система управления фотографиями для каталожных сущностей

## Обзор

Система обеспечивает хранение метаданных фотографий в БД и файлов в `public/uploads`, с возможностью получать список фото для сущности, загружать новые, удалять, менять порядок и назначать превью, с контролем доступа, валидацией и логированием.

## Модель данных

### Таблица `images`

Используется существующая таблица `images` с полями:
- `id` - уникальный идентификатор изображения
- `entity_type` - тип сущности (например, `'modules'`, `'materials'`)
- `entity_id` - ID записи в таблице соответствующей сущности
- `url` - относительный путь к файлу (например, `/uploads/modules/НМР1-15/НМР1-15_preview.jpg`)
- `alt` - альтернативный текст для изображения (опционально)
- `sort_order` - порядок сортировки (0 для превью, остальные по возрастанию)

### Превью изображений

- Превью определяется как запись с `sort_order = 0`
- Остальные изображения упорядочиваются по `sort_order` и `id` (ASC)
- При запросе вычисляется поле `is_preview` как `sort_order = 0`

### Структура хранения файлов

**Для модулей:**
- Файлы хранятся в `public/uploads/modules/{SKU}/`
- Имена файлов формируются на основе артикула (SKU):
  - Превью: `{SKU}_preview.{ext}`
  - Остальные: `{SKU}_1.{ext}`, `{SKU}_2.{ext}`, и т.д.

**Для других сущностей:**
- Файлы хранятся в `public/uploads/`
- Имена файлов: `{entityType}_{entityId}_{sortOrder}_{timestamp}.{ext}`

## API Эндпоинты

Все эндпоинты размещаются под префиксом `/api/images`.

### 1. GET `/api/images/:entityType/:entityId`

**Назначение:** Получить все изображения для сущности.

**Доступ:** Публичный (опциональная аутентификация)

**Параметры:**
- `entityType` (path) - тип сущности (например, `modules`, `materials`)
- `entityId` (path) - ID сущности (положительное целое число)

**Валидация:**
- Проверка наличия `entityType` и `entityId`
- Проверка, что `entityId` - положительное целое число

**Ответ:**
```json
{
  "data": [
    {
      "id": 1,
      "url": "/uploads/modules/НМР1-15/НМР1-15_preview.jpg",
      "alt": "Превью модуля",
      "sort_order": 0,
      "is_preview": true
    },
    {
      "id": 2,
      "url": "/uploads/modules/НМР1-15/НМР1-15_1.jpg",
      "alt": "Дополнительное фото",
      "sort_order": 1,
      "is_preview": false
    }
  ]
}
```

**Логирование:**
- Логируется запрос с указанием типа сущности, ID, количества изображений и пользователя

---

### 2. POST `/api/images`

**Назначение:** Загрузить новое изображение для сущности.

**Доступ:** Требуется аутентификация и роль `admin` или `manager`

**Content-Type:** `multipart/form-data`

**Параметры:**
- `file` (form-data, file) - файл изображения (обязательно)
- `entityType` (form-data, string) - тип сущности (обязательно)
- `entityId` (form-data, string) - ID сущности (обязательно, положительное число)
- `alt` (form-data, string) - альтернативный текст (опционально)

**Валидация:**
- Проверка наличия файла
- Проверка типа файла: только изображения (JPEG, PNG, GIF, WebP, SVG)
- Проверка размера файла: максимум 10MB
- Проверка обязательных полей `entityType` и `entityId`
- Проверка, что `entityId` - положительное целое число

**Логика:**
1. Определение `sort_order`:
   - Если это первое изображение сущности: `sort_order = 0`
   - Иначе: `sort_order = MAX(sort_order) + 1`
2. Для модулей:
   - Получение SKU из таблицы `modules`
   - Создание папки `public/uploads/modules/{SKU}/` если её нет
   - Формирование имени файла на основе SKU
3. Сохранение файла в соответствующую папку
4. Добавление записи в таблицу `images`

**Ответ:**
```json
{
  "data": {
    "id": 3,
    "url": "/uploads/modules/НМР1-15/НМР1-15_2.jpg",
    "alt": "Новое изображение",
    "sort_order": 2
  }
}
```

**Логирование:**
- Логируется успешная загрузка с указанием:
  - ID изображения
  - Типа сущности и ID
  - SKU (для модулей)
  - URL файла
  - Размера файла и MIME-типа
  - Пользователя и роли

---

### 3. DELETE `/api/images/:id`

**Назначение:** Удалить изображение.

**Доступ:** Требуется аутентификация и роль `admin` или `manager`

**Параметры:**
- `id` (path) - ID изображения (положительное целое число)

**Валидация:**
- Проверка корректности `id`
- Проверка существования изображения

**Логика:**
1. Получение информации об изображении из БД
2. Удаление файла из файловой системы (если существует)
3. Удаление записи из таблицы `images`
4. Для модулей: переименование оставшихся изображений для сохранения правильного порядка

**Ответ:** `204 No Content`

**Логирование:**
- Логируется удаление с указанием:
  - ID изображения
  - Типа сущности и ID
  - URL файла
  - Пользователя и роли

---

### 4. POST `/api/images/reorder`

**Назначение:** Изменить порядок изображений.

**Доступ:** Требуется аутентификация и роль `admin` или `manager`

**Content-Type:** `application/json`

**Тело запроса:**
```json
{
  "imageIds": [3, 1, 2]
}
```

**Параметры:**
- `imageIds` (array of integers) - массив ID изображений в нужном порядке (обязательно, непустой)

**Валидация:**
- Проверка, что `imageIds` - массив
- Проверка, что массив не пустой
- Проверка, что все элементы - положительные целые числа

**Логика:**
1. Получение информации о первом изображении для определения `entity_type` и `entity_id`
2. Обновление `sort_order` для каждого изображения по позиции в массиве:
   - Первое изображение (индекс 0): `sort_order = 0` (превью)
   - Остальные: `sort_order = индекс`
3. Для модулей: переименование файлов в соответствии с новым порядком

**Ответ:**
```json
{
  "message": "Порядок изображений обновлен"
}
```

**Логирование:**
- Логируется изменение порядка с указанием:
  - Типа сущности и ID
  - Массива ID изображений
  - Количества изображений
  - Пользователя и роли

---

### 5. POST `/api/images/:id/set-preview`

**Назначение:** Назначить изображение превью для сущности.

**Доступ:** Требуется аутентификация и роль `admin` или `manager`

**Параметры:**
- `id` (path) - ID изображения (положительное целое число)

**Валидация:**
- Проверка корректности `id`
- Проверка существования изображения

**Логика:**
1. Получение информации об изображении (`entity_type`, `entity_id`)
2. Если изображение уже является превью (`sort_order = 0`), возврат без изменений
3. Получение всех изображений сущности
4. Переупорядочивание: выбранное изображение становится первым (`sort_order = 0`), остальные сдвигаются
5. Для модулей: переименование файлов в соответствии с новым порядком

**Ответ:**
```json
{
  "message": "Превью установлено"
}
```

**Логирование:**
- Логируется установка превью с указанием:
  - ID изображения
  - Типа сущности и ID
  - Пользователя и роли

---

## Безопасность

### Аутентификация и авторизация

- Все модифицирующие эндпоинты (POST, DELETE) защищены:
  - `authGuard` - проверка JWT токена
  - `requireAdminOrManager` - проверка роли (только `admin` или `manager`)

### Валидация входных данных

- Проверка ID на целочисленность и положительность
- Проверка обязательных полей
- Проверка типов данных
- Валидация массива `imageIds` (непустой, все элементы - положительные числа)

### Валидация файлов

- Типы файлов: только изображения (JPEG, PNG, GIF, WebP, SVG)
- Максимальный размер: 10MB
- Проверка MIME-типа и расширения файла

### Статическая раздача файлов

- Настроена безопасная раздача `/uploads` с:
  - CORS заголовками
  - CORP/COEP политиками
  - Корректным `Content-Type` для изображений
  - Helmet защитой

---

## Логирование

Все операции логируются с использованием Winston logger:

### Успешные операции

- **Загрузка изображения:** ID изображения, тип сущности, ID, SKU, URL, размер файла, пользователь
- **Удаление изображения:** ID изображения, тип сущности, ID, URL, пользователь
- **Изменение порядка:** тип сущности, ID, массив ID изображений, количество, пользователь
- **Установка превью:** ID изображения, тип сущности, ID, пользователь

### Предупреждения

- Попытки доступа без указания обязательных параметров
- Некорректные ID
- Попытки удаления несуществующих изображений
- Некорректные данные в запросах

### Формат логов

```json
{
  "level": "info",
  "message": "Изображение успешно загружено",
  "imageId": 3,
  "entityType": "modules",
  "entityId": 1,
  "sku": "НМР1-15",
  "url": "/uploads/modules/НМР1-15/НМР1-15_2.jpg",
  "sortOrder": 2,
  "isPreview": false,
  "fileSize": 245678,
  "mimetype": "image/jpeg",
  "user": 5,
  "role": "admin",
  "userName": "Администратор",
  "timestamp": "2024-01-15T10:30:00.000Z"
}
```

---

## Обработка ошибок

Все ошибки обрабатываются через общий обработчик ошибок (`error.middleware.js`) и возвращают структурированный JSON ответ:

```json
{
  "message": "Описательное сообщение об ошибке",
  "statusCode": 400
}
```

### Типы ошибок

- `400 Bad Request` - ошибки валидации (некорректные параметры, неверный формат данных)
- `401 Unauthorized` - отсутствие или недействительность токена
- `403 Forbidden` - недостаточно прав (неправильная роль)
- `404 Not Found` - изображение или сущность не найдены
- `500 Internal Server Error` - внутренние ошибки сервера

---

## Примеры использования

### Получение изображений модуля

```bash
GET /api/images/modules/1
```

### Загрузка изображения

```bash
POST /api/images
Content-Type: multipart/form-data

file: [binary]
entityType: modules
entityId: 1
alt: Превью модуля НМР1-15
```

### Изменение порядка изображений

```bash
POST /api/images/reorder
Content-Type: application/json
Authorization: Bearer <token>

{
  "imageIds": [3, 1, 2]
}
```

### Установка превью

```bash
POST /api/images/3/set-preview
Authorization: Bearer <token>
```

---

## Особенности реализации

### Автоматическое переименование файлов модулей

При изменении порядка или удалении изображений модулей файлы автоматически переименовываются для сохранения правильной структуры именования на основе SKU.

### Безопасное переименование

Используется двухэтапное переименование через временные файлы для предотвращения конфликтов при одновременных операциях.

### Обработка ошибок файловой системы

Все операции с файлами обернуты в try-catch блоки с логированием предупреждений и попытками восстановления состояния при ошибках.

